<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --blue: #3b82f6; --red: #ef4444; --green: #22c55e; --bg: #f8fafc; --text: #1e293b; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 900px; margin: 0 auto; }
    
    .header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .status-badge { background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }

    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { flex: 1; padding: 15px; text-align: center; background: #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: bold; color: #64748b; transition: 0.2s; }
    .tab.active { background: white; color: var(--blue); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 2px solid var(--blue); }
    .tab.active.burn { color: var(--red); border-color: var(--red); }

    .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    
    label { display: block; font-size: 0.85em; color: #64748b; margin-bottom: 6px; font-weight: 600; }
    input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
    input:read-only { background: #f1f5f9; color: #64748b; cursor: not-allowed; }

    .result-box { background: #eff6ff; padding: 20px; border-radius: 12px; margin-top: 20px; border-left: 5px solid var(--blue); }
    .result-val { font-size: 1.8em; font-weight: 800; color: var(--blue); }
    .result-sub { font-size: 0.9em; margin-top: 5px; color: #475569; }

    button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 20px; color: white; transition: 0.2s; }
    .btn-supply { background: var(--blue); } .btn-supply:hover { background: #2563eb; }
    .btn-burn { background: var(--red); } .btn-burn:hover { background: #dc2626; }

    /* AI ë ˆí¬íŠ¸ ìŠ¤íƒ€ì¼ (AIê°€ ìƒì„±í•  HTMLìš©) */
    .ai-report { background: #1e293b; color: white; padding: 25px; border-radius: 12px; margin-top: 20px; line-height: 1.6; }
    .ai-report h3 { border-bottom: 1px solid #475569; padding-bottom: 10px; margin-top: 0; color: #fbbf24; }
    .ai-bar-bg { background: #334155; height: 10px; border-radius: 5px; margin: 5px 0 15px 0; overflow: hidden; }
    .ai-bar-fill { height: 100%; border-radius: 5px; }
    .ai-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 5px; }
    .tag-risk { background: #ef4444; color: white; }
    .tag-safe { background: #22c55e; color: white; }
  </style>
</head>
<body>

  <div class="header">
    <h2>ğŸ“Š ì„¯ë‹¤ ë°¸ëŸ°ì‹± ë§ˆìŠ¤í„° (V4)</h2>
    <div class="status-badge" id="serverInfo">ì„œë²„ ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="setMode('supply')" id="tabS">ğŸ’° ì§€ê¸‰(Supply)</div>
    <div class="tab" onclick="setMode('burn')" id="tabB">ğŸ”¥ íŒìˆ˜ìœ ë„(Burn)</div>
  </div>

  <div id="viewSupply" class="card">
    <div class="row">
      <div>
        <label>íƒ€ê²Ÿ ë“±ê¸‰ (DB ìë™ì—°ë™)</label>
        <select id="s_tier" onchange="updateTierInfo('supply')">
          <option value="whale">VIP/ê³ ë˜ (ìƒìœ„ 10%)</option>
          <option value="normal" selected>ì¼ë°˜ ìœ ì € (ì¤‘ìœ„ 40%)</option>
          <option value="light">ë¼ì´íŠ¸ ìœ ì € (í•˜ìœ„ 50%)</option>
        </select>
      </div>
      <div>
        <label>ëŒ€ìƒ ì¸ì› (ëª…)</label>
        <input type="number" id="s_users" readonly>
      </div>
    </div>
    
    <div class="row">
      <div>
        <label>1ì¸ë‹¹ 1ì¼ ì§€ê¸‰ì•¡</label>
        <input type="text" id="s_amount" value="100,000" oninput="formatNum(this); calcSupply()">
      </div>
      <div>
        <label>ì´ë²¤íŠ¸ ê¸°ê°„ (ì¼)</label>
        <input type="number" id="s_days" value="7" oninput="calcSupply()">
      </div>
    </div>

    <div class="result-box">
      <div style="font-size:0.9em; font-weight:bold;">ì´ í’€ë¦¬ëŠ” ê¸ˆì•¡ (Total Impact)</div>
      <div class="result-val" id="s_total">0</div>
      <div class="result-sub">
        ì¸í”Œë ˆì´ì…˜ìœ¨: <span id="s_infl" style="font-weight:bold; color:#ef4444;">0.00%</span> ì¦ê°€
      </div>
    </div>

    <button class="btn-supply" onclick="runAI()">ğŸ¤– AI ë°¸ëŸ°ì‹± ë¦¬í¬íŠ¸ ìƒì„±</button>
  </div>

  <div id="viewBurn" class="card" style="display:none;">
    <div class="row">
      <div>
        <label>íƒ€ê²Ÿ ë“±ê¸‰</label>
        <select id="b_tier" onchange="updateTierInfo('burn')">
          <option value="whale">VIP/ê³ ë˜</option>
          <option value="normal" selected>ì¼ë°˜ ìœ ì €</option>
          <option value="light">ë¼ì´íŠ¸ ìœ ì €</option>
        </select>
      </div>
      <div>
        <label>í˜„ì¬ í‰ê·  íŒìˆ˜ (ì¼)</label>
        <input type="number" id="b_avg" readonly style="background:#f1f5f9; color:#64748b;">
      </div>
    </div>

    <div class="row">
      <div>
        <label>ğŸ¯ ëª©í‘œ íŒìˆ˜ (ë¯¸ì…˜ ì¡°ê±´)</label>
        <input type="number" id="b_target" value="100" oninput="calcBurn()">
        <div style="font-size:0.8em; color:#2563eb; margin-top:5px;" id="b_gap_text">
          +00íŒ ë” ì¹˜ë„ë¡ ìœ ë„
        </div>
      </div>
      <div>
        <label>ë³´ìƒ ì§€ê¸‰ì•¡ (ì„±ê³µ ì‹œ)</label>
        <input type="text" id="b_reward" value="50,000" oninput="formatNum(this); calcBurn()">
      </div>
    </div>

    <div class="result-box" style="border-left-color: var(--red); background: #fef2f2;">
      <div style="font-size:0.9em; font-weight:bold;">ìˆœìˆ˜ ì¦ê° (Net Change)</div>
      <div class="result-val" id="b_net" style="color:var(--red);">0</div>
      <div class="result-sub">
        <span id="b_burn_total">ì´ 0 íšŒìˆ˜</span> (ì¶”ê°€ìœ ë„ë¶„: <span id="b_burn_extra" style="font-weight:bold;">0</span>)
      </div>
    </div>

    <button class="btn-burn" onclick="runAI()">ğŸ¤– AI ë¯¸ì…˜ ë‚œì´ë„ ë¶„ì„</button>
  </div>

  <div id="aiResult" style="display:none;"></div>

  <script>
    let db = {};
    let mode = 'supply';

    window.onload = function() {
      google.script.run.withSuccessHandler(init).getV4Stats();
    };

    function init(data) {
      if(data.error) return alert("Error: " + data.error);
      db = data;
      
      document.getElementById('serverInfo').innerText = 
        `ì„œë²„ ì´ í†µí™”ëŸ‰: ${format(db.serverMoney)} | ì „ì²´ ìœ ì €: ${format(db.dau)}ëª…`;
      
      updateTierInfo('supply');
    }

    function setMode(m) {
      mode = m;
      document.getElementById('viewSupply').style.display = (m==='supply')?'block':'none';
      document.getElementById('viewBurn').style.display = (m==='burn')?'block':'none';
      document.getElementById('tabS').className = (m==='supply')?'tab active':'tab';
      document.getElementById('tabB').className = (m==='burn')?'tab active burn':'tab';
      document.getElementById('aiResult').style.display = 'none';
      
      if(m === 'burn') updateTierInfo('burn');
    }

    // ë“±ê¸‰ ì„ íƒ ì‹œ DBê°’ ìë™ ë§¤í•‘ (í•µì‹¬ ê¸°ëŠ¥!)
    function updateTierInfo(m) {
      const tierKey = document.getElementById(m === 'supply' ? 's_tier' : 'b_tier').value;
      const tierData = db.tiers[tierKey];

      if(m === 'supply') {
        // ì¸ì› ìˆ˜ ìë™ ì…ë ¥
        document.getElementById('s_users').value = tierData.count;
        calcSupply();
      } else {
        // í‰ê·  íŒìˆ˜ ìë™ ì…ë ¥
        document.getElementById('b_avg').value = Math.round(tierData.avgPlay);
        // ëª©í‘œ íŒìˆ˜ ê¸°ë³¸ê°’: í‰ê·  + 20%
        document.getElementById('b_target').value = Math.round(tierData.avgPlay * 1.2);
        calcBurn();
      }
    }

    function calcSupply() {
      const users = parse('s_users');
      const amount = parse('s_amount');
      const days = parse('s_days');
      
      const total = users * amount * days;
      const infl = (total / db.serverMoney) * 100;

      document.getElementById('s_total').innerText = "+" + format(total);
      document.getElementById('s_infl').innerText = infl.toFixed(5) + "%";
    }

    function calcBurn() {
      const tierKey = document.getElementById('b_tier').value;
      const tierData = db.tiers[tierKey];
      
      const currentAvg = parseFloat(document.getElementById('b_avg').value);
      const target = parseFloat(document.getElementById('b_target').value);
      const reward = parse('b_reward');
      const users = tierData.count; // í•´ë‹¹ ë“±ê¸‰ ì „ì²´ ëŒ€ìƒ ê°€ì • (í˜¹ì€ ì…ë ¥ê°’ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)

      // ìœ ë„ íŒìˆ˜ (Gap)
      const gap = target - currentAvg;
      document.getElementById('b_gap_text').innerText = 
        gap > 0 ? `ğŸ”¥ +${gap}íŒ ë” ì¹˜ë„ë¡ ìœ ë„ (ë‚œì´ë„ ì¦ê°€)` : `âš ï¸ í‰ê· ë³´ë‹¤ ë‚®ìŒ (ë³€ë³„ë ¥ ì—†ìŒ)`;

      // íšŒìˆ˜ ê³„ì‚°
      // 1. ì´ íšŒìˆ˜ = (íƒ€ê²ŸíŒìˆ˜ * íŒë‹¹íšŒìˆ˜ê¸ˆ * ì¸ì›)
      // 2. ì¶”ê°€ íšŒìˆ˜ = (Gap * íŒë‹¹íšŒìˆ˜ê¸ˆ * ì¸ì›)
      const burnRate = tierData.burn;
      const totalBurn = target * burnRate * users;
      const extraBurn = gap * burnRate * users;
      const totalReward = reward * users;

      // ìˆœìˆ˜ ì¦ê° = ë³´ìƒì§€ê¸‰ - ì´íšŒìˆ˜ (íšŒìˆ˜ê°€ ë” ë§ìœ¼ë©´ ë§ˆì´ë„ˆìŠ¤)
      const net = totalReward - totalBurn; 

      document.getElementById('b_net').innerText = (net > 0 ? "+" : "") + format(net);
      document.getElementById('b_net').style.color = (net > 0) ? "var(--blue)" : "var(--red)";
      
      document.getElementById('b_burn_total').innerText = "ì´ " + format(totalBurn) + " íšŒìˆ˜";
      document.getElementById('b_burn_extra').innerText = format(extraBurn) + " (ì¶”ê°€íš¨ê³¼)";
    }

    function runAI() {
      const resBox = document.getElementById('aiResult');
      resBox.style.display = 'block';
      resBox.innerHTML = '<div style="text-align:center; color:white;">ğŸ“Š AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

      const tierKey = document.getElementById(mode === 'supply' ? 's_tier' : 'b_tier').value;
      
      let payload = {
        mode: mode,
        targetTier: tierKey,
        users: db.tiers[tierKey].count
      };

      if(mode === 'supply') {
        payload.impactLabel = "ì´ ì§€ê¸‰ì•¡(Supply)";
        payload.totalImpact = document.getElementById('s_total').innerText;
        payload.percent = document.getElementById('s_infl').innerText.replace("%","");
        payload.detail1 = `1ì¸ë‹¹ ${document.getElementById('s_amount').value} ë¨¸ë‹ˆ ì§€ê¸‰`;
        payload.detail2 = `ê¸°ê°„: ${document.getElementById('s_days').value}ì¼ê°„`;
      } else {
        payload.impactLabel = "ìˆœìˆ˜ íšŒìˆ˜ì•¡(Net Burn)";
        payload.totalImpact = document.getElementById('b_net').innerText;
        payload.percent = "í•´ë‹¹ì—†ìŒ"; // íšŒìˆ˜ìœ¨ ê³„ì‚° ë³µì¡í•˜ë‹ˆ ìƒëµ
        payload.detail1 = `ëª©í‘œ: ${document.getElementById('b_target').value}íŒ (í‰ê·  ëŒ€ë¹„ +${parseInt(document.getElementById('b_target').value) - parseInt(document.getElementById('b_avg').value)})`;
        payload.detail2 = `ì„±ê³µë³´ìƒ: ${document.getElementById('b_reward').value} ë¨¸ë‹ˆ`;
      }

      google.script.run.withSuccessHandler(function(html) {
        resBox.innerHTML = html; // AIê°€ ì¤€ HTML ë Œë”ë§
      }).askAI_Visual(payload);
    }

    function formatNum(el) { el.value = Number(el.value.replace(/,/g,'')).toLocaleString(); }
    function parse(id) { return parseFloat(document.getElementById(id).value.replace(/,/g,'')) || 0; }
    function format(n) { return Math.round(n).toLocaleString(); }
  </script>
</body>
</html>