<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>AI 회의록 도서관 (확장)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter 폰트 적용 및 기본 스타일 설정 */
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
    /* 왼쪽 목록 항목 스타일 */
    .log-list-item {
      cursor: pointer;
      border-left: 4px solid transparent;
      transition: all 0.2s;
    }
    .log-list-item:hover {
      background-color: #f0f4f8;
      border-left-color: #a5b4fc; /* light indigo */
    }
    .log-list-item.active {
      background-color: #e0e7ff; /* indigo-100 */
      border-left-color: #4f46e5; /* indigo-600 */
      font-weight: 600;
    }
    /* 스크롤바 스타일 */
    #logs-sidebar {
      max-height: calc(100vh - 120px); /* 화면 높이에 맞춤 */
      overflow-y: auto;
    }
  </style>
  <script>
    // 전역 상태
    let isLoading = false;
    let allLogs = []; // 전체 로그 데이터 저장
    let selectedLogId = null; // 현재 선택된 로그의 ID

    // GAS 스크립트 실행 함수
    const server = google.script.run
      .withSuccessHandler(onProcessSuccess)
      .withFailureHandler(onProcessFailure);

    // ======================== UI Helper Functions =========================

    function setLoading(show, message = '처리 중...') {
      const statusDiv = document.getElementById('status-message');
      const submitBtn = document.getElementById('submit-btn');

      isLoading = show;
      if (show) {
        statusDiv.classList.remove('hidden', 'bg-red-100', 'bg-green-100');
        statusDiv.classList.add('bg-blue-100', 'flex');
        statusDiv.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${message}`;
        submitBtn.disabled = true;
      } else {
        statusDiv.classList.add('hidden');
        statusDiv.classList.remove('flex');
        submitBtn.disabled = false;
      }
    }

    function showResult(success, message) {
      setLoading(false);
      const statusDiv = document.getElementById('status-message');
      statusDiv.classList.remove('hidden', 'bg-blue-100', 'bg-red-100', 'bg-green-100');
      statusDiv.classList.add(success ? 'bg-green-100' : 'bg-red-100', 'flex');
      statusDiv.innerHTML = success 
        ? `<div class="font-medium text-green-800">${message}</div>`
        : `<div class="font-medium text-red-800">오류: ${message}</div>`;
      
      setTimeout(() => statusDiv.classList.add('hidden'), 5000);
    }

    // ======================== Core Rendering Functions =========================

    // 회의록 목록(사이드바) 렌더링
    function renderSidebar(logs) {
      const sidebar = document.getElementById('logs-sidebar-list');
      sidebar.innerHTML = '';
      
      if (logs.length === 0) {
        sidebar.innerHTML = '<p class="text-center text-gray-500 p-4">검색 결과가 없습니다.</p>';
        return;
      }

      logs.forEach(log => {
        const item = document.createElement('div');
        item.id = `log-item-${log.id}`;
        item.className = `log-list-item p-3 space-y-1 hover:bg-gray-50 rounded-lg`;
        item.setAttribute('onclick', `selectLog(${log.id})`);
        item.innerHTML = `
          <p class="text-sm text-gray-800">${log.title}</p>
          <p class="text-xs text-gray-500">${log.date}</p>
        `;
        sidebar.appendChild(item);
      });
      
      // 목록이 업데이트되면, 이전에 선택된 항목을 유지하거나 첫 번째 항목을 선택
      if (logs.length > 0) {
        if (!selectedLogId || !logs.find(log => log.id === selectedLogId)) {
          selectLog(logs[0].id);
        } else {
          selectLog(selectedLogId);
        }
      } else {
        renderDetail(null); // 목록이 비면 상세 정보 초기화
      }
    }

    // 회의록 상세 내용 렌더링
    function renderDetail(log) {
      const detailContainer = document.getElementById('log-detail-container');
      
      if (!log) {
        detailContainer.innerHTML = '<div class="text-center p-12 text-gray-500 bg-white rounded-xl shadow-lg border border-gray-100">왼쪽 목록에서 회의록을 선택하여 상세 내용을 확인하세요.</div>';
        selectedLogId = null;
        return;
      }

      // 할 일 목록 HTML 생성
      const tasksHtml = log.tasks.split('\n').map(task => 
        `<li class="flex items-start"><svg class="w-5 h-5 mr-2 mt-0.5 text-indigo-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3a2 2 0 012-2h4a2 2 0 012 2v2m-6 0h6"></path></svg><span class="text-gray-800">${task}</span></li>`
      ).join('');
      
      // 태그 목록 HTML 생성
      const tagsHtml = log.tags.split(', ').map(tag => 
        `<span class="inline-block bg-indigo-100 text-indigo-700 text-sm px-3 py-1 rounded-full font-semibold mr-2 mb-2">#${tag}</span>`
      ).join('');
      
      // 상세 내용 HTML
      detailContainer.innerHTML = `
        <div class="bg-white p-8 rounded-xl shadow-2xl border border-indigo-200">
          <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-3xl font-bold text-gray-800">${log.title}</h2>
            <span class="text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">${log.date}</span>
          </div>

          <div class="mb-8 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
            <p class="text-lg font-semibold text-yellow-800 mb-2 flex items-center">
              <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m-4 5h8a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              AI 핵심 요약
            </p>
            <p class="text-gray-700 leading-relaxed">${log.summary}</p>
          </div>
          
          <div class="mb-8">
            <p class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">회의 내용 상세 정리</p>
            <div class="text-gray-700 leading-relaxed space-y-4">
                ${log.organizedContent.split('\n').map(p => `<p>${p}</p>`).join('')}
            </div>
          </div>

          <div class="mb-8">
            <p class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">주요 태그</p>
            <div>${tagsHtml || '<span class="text-gray-500">태그 없음</span>'}</div>
          </div>
          
          <div class="mb-8">
            <p class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">핵심 할 일 (Action Items)</p>
            <ul class="list-none space-y-3 pl-0">${tasksHtml || '<span class="text-gray-500">할 일 없음</span>'}</ul>
          </div>
          
          <details class="text-sm text-gray-500 cursor-pointer pt-4 border-t mt-6">
            <summary class="font-medium text-lg text-gray-600 hover:text-gray-800">원문 녹취록 보기 (클릭)</summary>
            <pre class="whitespace-pre-wrap mt-3 p-4 bg-gray-100 rounded-lg max-h-60 overflow-y-auto text-sm">${log.transcript}</pre>
          </details>
        </div>
      `;
    }

    // ======================== Event Handlers =========================

    // 목록 항목 클릭 시 상세 내용 표시
    function selectLog(id) {
      // 이전에 활성화된 항목 비활성화
      if (selectedLogId) {
        document.getElementById(`log-item-${selectedLogId}`)?.classList.remove('active');
      }
      
      const log = allLogs.find(l => l.id === id);
      if (log) {
        selectedLogId = id;
        document.getElementById(`log-item-${selectedLogId}`)?.classList.add('active');
        renderDetail(log);
      }
    }

    // 검색 실행 (키 입력 시 자동 실행)
    function handleSearch() {
      const keyword = document.getElementById('search-input').value;
      // Code.gs의 searchLogs 함수를 호출하고 결과를 onProcessSuccess로 받음
      server.searchLogs(keyword); 
    }

    // 폼 제출 핸들러 (날짜 필드 추가)
    function handleFormSubmit(event) {
      event.preventDefault();
      
      const date = document.getElementById('meeting-date').value.trim();
      const title = document.getElementById('meeting-title').value.trim();
      const transcript = document.getElementById('meeting-transcript').value.trim();

      if (!date || !title || !transcript) {
        showResult(false, '회의 날짜, 제목, 녹취록 원문을 모두 입력해야 합니다.');
        return;
      }

      setLoading(true, 'AI가 녹취록을 심층 분석하고 있습니다...');

      // Code.gs의 processTranscript 함수 호출 (날짜 인자 추가)
      server.processTranscript(date, title, transcript);
    }

    // processTranscript 성공 콜백 (등록 후와 목록/검색 조회 후 모두 받음)
    function onProcessSuccess(result) {
      if (typeof result === 'object' && result.success !== undefined) {
          // 1. 등록 성공 후 콜백
          document.getElementById('meeting-form').reset(); 
          showResult(result.success, result.message);
          if (result.success) {
            // 등록 후 전체 목록 다시 불러오기
            server.getAllMeetingLogs(); 
          }
      } else if (Array.isArray(result)) {
          // 2. 목록 불러오기 (getAllMeetingLogs 또는 searchLogs) 성공 후 콜백
          allLogs = result;
          renderSidebar(allLogs);
      }
    }

    // processTranscript 실패 콜백
    function onProcessFailure(error) {
      console.error('GAS Function Call Error:', error);
      showResult(false, '시스템 오류가 발생했습니다. 자세한 내용은 콘솔 로그를 확인하세요.');
    }

    // 페이지 로드 시 초기 데이터 로드
    window.onload = function() {
      // 오늘 날짜를 기본값으로 설정
      document.getElementById('meeting-date').valueAsDate = new Date();
      
      document.getElementById('meeting-form').addEventListener('submit', handleFormSubmit);
      document.getElementById('search-input').addEventListener('input', handleSearch);

      // 초기 목록 로딩
      server.getAllMeetingLogs();
    };
  </script>
</head>
<body class="p-0 md:p-0 min-h-screen flex flex-col">
  <header class="text-center p-6 bg-white border-b shadow-sm">
      <h1 class="text-3xl font-extrabold text-indigo-700 mb-1">AI 회의록 도서관</h1>
      <p class="text-gray-600 text-sm">심층 분석, 태그 추출 및 검색이 가능한 아카이빙 시스템</p>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <div class="w-full md:w-1/3 lg:w-1/4 bg-gray-50 border-r p-4 flex flex-col">
      
      <div class="mb-4">
        <input type="text" id="search-input" placeholder="제목, 요약, 태그에서 키워드 검색" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-sm">
      </div>

      <h3 class="text-lg font-bold text-gray-700 mb-3">날짜별 회의록 목록</h3>
      
      <div id="logs-sidebar" class="flex-1 overflow-y-auto space-y-1 pr-1">
        <div id="logs-sidebar-list">
          <p class="text-center text-gray-500 py-4 text-sm">목록을 불러오는 중...</p>
        </div>
      </div>
    </div>
    
    <main class="flex-1 p-6 overflow-y-auto">
      <div class="max-w-4xl mx-auto">
        
        <div id="status-message" class="hidden p-4 mb-6 rounded-lg shadow-md items-center transition duration-300">
          </div>

        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-8 border border-indigo-100">
          <h2 class="text-2xl font-semibold text-indigo-600 mb-6 border-b pb-3">새 회의록 분석 요청 및 등록</h2>
          <form id="meeting-form" class="space-y-4">
            <div class="flex space-x-4">
                <div class="w-1/3">
                    <label for="meeting-date" class="block text-sm font-medium text-gray-700 mb-1">회의 날짜</label>
                    <input type="date" id="meeting-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div class="w-2/3">
                    <label for="meeting-title" class="block text-sm font-medium text-gray-700 mb-1">회의 제목</label>
                    <input type="text" id="meeting-title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="예: 2024년 3분기 프로젝트 기획 회의">
                </div>
            </div>
            <div>
              <label for="meeting-transcript" class="block text-sm font-medium text-gray-700 mb-1">녹취록 원문</label>
              <textarea id="meeting-transcript" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="회의의 전체 녹취록 텍스트를 붙여넣어 주세요. (최소 200자 권장)"></textarea>
            </div>
            <button type="submit" id="submit-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
              <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m-4 5h8a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              AI로 심층 분석하고 도서관에 등록
            </button>
          </form>
        </div>
        
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">회의록 상세 내용</h2>
        <div id="log-detail-container">
          <div class="text-center p-12 text-gray-500 bg-white rounded-xl shadow-lg border border-gray-100">왼쪽 목록에서 회의록을 선택하여 상세 내용을 확인하세요.</div>
        </div>

      </div>
    </main>
  </div>
  
</body>
</html>